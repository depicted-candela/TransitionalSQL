
-- DDL and DML for the 'horizons' user schema.
-- This script is idempotent and can be run multiple times.
-- DROP USER horizons CASCADE;
CREATE USER horizons IDENTIFIED BY YourPassword;

-- Clean up existing objects to ensure a clean slate
BEGIN
    FOR r IN (SELECT object_name, object_type FROM user_objects WHERE object_type IN ('TABLE', 'PROCEDURE', 'PACKAGE', 'PACKAGE BODY', 'TYPE', 'QUEUE', 'QUEUE TABLE', 'SEQUENCE')) LOOP
        BEGIN
            EXECUTE IMMEDIATE 'DROP ' || r.object_type || ' IF EXISTS "' || r.object_name || '"' || CASE WHEN r.object_type = 'TABLE' THEN ' PURGE' ELSE '' END;
        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE('Could not drop ' || r.object_type || ' ' || r.object_name);
        END;
    END LOOP;
END;
/

-- TYPES
-- An object type for our messaging queue payload, required for Oracle AQ/JMS
CREATE OR REPLACE TYPE horizons.PartRequestType AS OBJECT (
    orderId         NUMBER(10),
    partId          NUMBER(10),
    quantity        NUMBER(5),
    requestTimestamp TIMESTAMP WITH TIME ZONE
);
/

-- TABLE DEFINITIONS
-- Hierarchical product catalog using modern DDL features
CREATE TABLE horizons.productCatalog (
    partId          NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    partName        VARCHAR2(100) NOT NULL,
    parentPartId    NUMBER REFERENCES horizons.productCatalog(partId),
    isReservable    BOOLEAN DEFAULT TRUE NOT NULL -- New 23ai BOOLEAN type
) ANNOTATIONS (DisplayName 'Master Product Hierarchy', Version '1.1');
COMMENT ON TABLE horizons.productCatalog IS 'Hierarchical bill of materials for all products.';

-- Main order table
CREATE TABLE horizons.customerOrders (
    orderId         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    orderDate       DATE DEFAULT SYSDATE,
    customerName    VARCHAR2(100),
    orderStatus     VARCHAR2(20) DEFAULT 'PENDING'
);

-- Order details stored efficiently as native XMLTYPE, required for XML processing exercises
CREATE TABLE horizons.orderDetails (
    orderId         NUMBER PRIMARY KEY REFERENCES horizons.customerOrders(orderId),
    detailXML       XMLTYPE
);

-- Configuration table for multicloud feature exercise
CREATE TABLE horizons.appConfiguration (
    configKey       VARCHAR2(100) PRIMARY KEY,
    configValue     VARCHAR2(500)
);
COMMENT ON TABLE horizons.appConfiguration IS 'Stores config data, potentially sourced from Azure or OCI';

-- ADVANCED QUEUING (AQ) SETUP for JMS exercises
-- 1. Create a queue table to hold the messages
BEGIN
    DBMS_AQADM.CREATE_QUEUE_TABLE(
        queue_table        => 'horizons.partRequestQueueTable',
        queue_payload_type => 'horizons.PartRequestType',
        multiple_consumers => TRUE, -- Important for topic-like behavior in JMS
        comment            => 'Queue table for component reservation requests'
    );
END;
/

-- 2. Create the actual queue (will be treated as a JMS Topic)
BEGIN
    DBMS_AQADM.CREATE_QUEUE(
        queue_name  => 'horizons.partRequestTopic',
        queue_table => 'horizons.partRequestQueueTable'
    );
END;
/

-- 3. Start the queue for enqueue and dequeue operations
BEGIN
    DBMS_AQADM.START_QUEUE(queue_name => 'horizons.partRequestTopic', enqueue => TRUE, dequeue => TRUE);
END;
/

-- DATA POPULATION
INSERT INTO horizons.productCatalog (partId, partName, parentPartId) VALUES (1, 'Gaming PC', NULL);
INSERT INTO horizons.productCatalog (partId, partName, parentPartId) VALUES (10, 'Motherboard Assembly', 1);
INSERT INTO horizons.productCatalog (partId, partName, parentPartId) VALUES (20, 'CPU', 10);
INSERT INTO horizons.productCatalog (partId, partName, parentPartId) VALUES (30, 'RAM 32GB Kit', 10);
INSERT INTO horizons.productCatalog (partId, partName, parentPartId) VALUES (40, 'GPU', 1);

INSERT INTO horizons.customerOrders (customerName) VALUES ('Alice');
INSERT INTO horizons.orderDetails (orderId, detailXML) VALUES (
  (SELECT orderId FROM customerOrders WHERE customerName = 'Alice'),
  XMLTYPE('&lt;order anbr="ORD201"&gt;
             &lt;items&gt;
               &lt;item partNumber="20" quantity="1"/&gt;
               &lt;item partNumber="30" quantity="2"/&gt;
             &lt;/items&gt;
           &lt;/order&gt;')
);

INSERT INTO horizons.customerOrders (customerName) VALUES ('Bob');
INSERT INTO horizons.orderDetails (orderId, detailXML) VALUES (
  (SELECT orderId FROM customerOrders WHERE customerName = 'Bob'),
  XMLTYPE('&lt;order anbr="ORD202"&gt;
             &lt;items&gt;
               &lt;item partNumber="40" quantity="1"/&gt;
             &lt;/items&gt;
           &lt;/order&gt;')
);

INSERT INTO horizons.appConfiguration (configKey, configValue) VALUES ('azure.config.connectionstring', 'Endpoint=https://myapp.azconfig.io;Id=xxxx;Secret=xxxx');
INSERT INTO horizons.appConfiguration (configKey, configValue) VALUES ('oci.objectstorage.bucket.uri', 'oci://my-bucket@my-tenancy/config/app.json');

COMMIT;

-- Grant necessary privileges for subsequent exercises
GRANT EXECUTE ON horizons.PartRequestType TO PUBLIC;
BEGIN
    DBMS_AQADM.GRANT_QUEUE_PRIVILEGE('ENQUEUE', 'horizons.partRequestTopic', 'PUBLIC');
    DBMS_AQADM.GRANT_QUEUE_PRIVILEGE('DEQUEUE', 'horizons.partRequestTopic', 'PUBLIC');
END;
/